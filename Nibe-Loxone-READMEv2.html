<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>README â€“ Nibe â†’ Loxone (myUplink API v2)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 2rem;
      line-height: 1.5;
      background: #0b1120;
      color: #e5e7eb;
    }
    h1, h2, h3 {
      color: #e5e7eb;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }
    h2 {
      font-size: 1.4rem;
      margin-top: 1.5rem;
    }
    h3 {
      font-size: 1.1rem;
      margin-top: 1rem;
    }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    pre {
      background: #020617;
      border-radius: 10px;
      padding: 10px 12px;
      overflow-x: auto;
      border: 1px solid #1f2937;
    }
    hr {
      border: none;
      border-top: 1px solid #1f2937;
      margin: 1.5rem 0;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 800px;
      margin-top: 0.5rem;
    }
    th, td {
      border: 1px solid #1f2937;
      padding: 6px 8px;
      text-align: left;
      font-size: 0.9rem;
    }
    th {
      background: #020617;
    }
    a { color: #7dd3fc; }
  </style>
</head>
<body>

<h1>ğŸ“˜ NÃ¡vod: Nibe â†’ Loxone (myUplink API v2) na Synology / Linuxu</h1>

<p>Tento projekt umoÅ¾Åˆuje ÄÃ­st data z <strong>Nibe tepelnÃ©ho Äerpadla</strong> pomocÃ­ <strong>myUplink API v2</strong> a posÃ­lat je do <strong>Loxone Miniserveru</strong> pÅ™es <strong>HTTP Virtual Inputs</strong>, bez pouÅ¾itÃ­ Modbus rozhranÃ­.</p>

<p>SouÄÃ¡stÃ­ balÃ­Äku jsou tyto soubory:</p>
<pre><code>nibe.py
config.ini
points_map.json (vygeneruje se pÅ™Ã­kazem)
token.json (vytvoÅ™Ã­ se automaticky po prvnÃ­m spuÅ¡tÄ›nÃ­)
nibe.log
</code></pre>

<hr />

<h2>ğŸ§© Co je potÅ™eba</h2>
<ul>
  <li>ÃšÄet na <strong>myUplink</strong></li>
  <li><strong>Application</strong> v developer portÃ¡lu myUplink</li>
  <li><strong>Python 3.9</strong> nainstalovanÃ½ jako balÃ­Äek na Synology (dÅ¯leÅ¾itÃ©!)</li>
  <li>PÅ™Ã­stup pÅ™es SSH</li>
  <li>Loxone Miniserver</li>
</ul>

<hr />

<h2>ğŸ Instalace Pythonu na Synology</h2>

<p>NeÅ¾ cokoli spustÃ­te, nainstalujte Python z BalÃ­ÄkovacÃ­ho centra:</p>

<p><strong>DSM â†’ BalÃ­ÄkovacÃ­ centrum â†’ Hledat: Python â†’ Nainstalovat Python 3.9</strong></p>

<p>OvÄ›Å™enÃ­ verze:</p>
<pre><code>which python3
python3 --version
</code></pre>

<p>SprÃ¡vnÄ› mÃ¡ bÃ½t vÃ½sledek napÅ™.:</p>
<pre><code>/bin/python3
Python 3.9.13
</code></pre>

<p>Pokud je tam jen <code>/bin/python3</code>, jde o vestavÄ›nÃ½ Python bez pip â€” skript nebude fungovat.</p>

<hr />

<hr />

<h2>ğŸ”‘ PÅ™ipojenÃ­ na Synology pÅ™es SSH</h2>

<p>NeÅ¾ budete pokraÄovat v instalaci a konfiguraci, je potÅ™eba pÅ™ihlÃ¡sit se na NAS pÅ™es SSH.</p>

<h3>Aktivace SSH v DSM</h3>
<ol>
  <li>OtevÅ™ete <strong>OvlÃ¡dacÃ­ panel</strong></li>
  <li>PÅ™ejdÄ›te na <strong>TerminÃ¡l &amp; SNMP</strong></li>
  <li>ZaÅ¡krtnÄ›te volbu <strong>Povolit sluÅ¾bu SSH</strong></li>
  <li>Port ponechte <strong>22</strong></li>
  <li>KliknÄ›te <strong>PouÅ¾Ã­t</strong></li>
</ol>

<h3>PÅ™ipojenÃ­ z Windows (PuTTY)</h3>
<ul>
  <li>StÃ¡hnÄ›te PuTTY: <a href="https://www.putty.org" target="_blank">https://www.putty.org</a></li>
  <li>Host Name: <code>IP_vaÅ¡eho_NAS</code></li>
  <li>Port: <code>22</code></li>
  <li>Connection type: <strong>SSH</strong></li>
  <li>PÅ™ihlÃ¡sit se uÅ¾ivatelem s oprÃ¡vnÄ›nÃ­m <code>sudo</code> nebo <code>admin</code></li>
</ul>

<h3>PÅ™ipojenÃ­ z macOS / Linux</h3>
<pre><code>ssh admin@192.168.x.x
</code></pre>

<h3>PÅ™epnutÃ­ do root reÅ¾imu</h3>
<pre><code>sudo -i
</code></pre>

<p>OvÄ›Å™enÃ­:</p>
<pre><code>whoami
</code></pre>

<p>SprÃ¡vnÃ½ vÃ½stup:</p>
<pre><code>root
</code></pre>

<p><strong>PoznÃ¡mka:</strong> Pokud sudo nefunguje, je potÅ™eba jej povolit v DSM:
<code>OvlÃ¡dacÃ­ panel â†’ UÅ¾ivatelÃ© â†’ Upravit â†’ PrÃ¡va aplikacÃ­ â†’ Povolit sudo</code></p>

<p>Pro vyÅ¡Å¡Ã­ bezpeÄnost je moÅ¾nÃ© po dokonÄenÃ­ konfigurace SSH opÄ›t vypnout:
<code>OvlÃ¡dacÃ­ panel â†’ TerminÃ¡l &amp; SNMP â†’ vypnout SSH</code></p>

<hr />


<h2>ğŸ“¦ Instalace pip a knihovny Requests</h2>

<pre><code>sudo -i
/bin/python3 -m ensurepip
/bin/python3 -m pip install requests
</code></pre>

<p>OvÄ›Å™enÃ­ instalace:</p>
<pre><code>/bin/python3 -c "import requests; print(hasattr(requests,'post'))"
</code></pre>

<p>VÃ½stup musÃ­ bÃ½t:</p>
<pre><code>True
</code></pre>

<hr />

<hr />

<h2>ğŸ“ UmÃ­stÄ›nÃ­ souborÅ¯ na NAS / Linux</h2>

<p>Celou sloÅ¾ku se skripty nahrajte na Synology do adresÃ¡Å™e, ze kterÃ©ho bude skript trvale bÄ›Å¾et. DoporuÄenÃ© umÃ­stÄ›nÃ­ je:</p>

<pre><code>/volume1/nibe
</code></pre>

<p>Struktura sloÅ¾ek by mÄ›la vypadat takto:</p>

<pre><code>/volume1/nibe/
 â”œâ”€â”€ nibe.py
 â”œâ”€â”€ config.ini
 â”œâ”€â”€ points_map.json
 â”œâ”€â”€ token.json        (vytvoÅ™Ã­ se automaticky po prvnÃ­m spuÅ¡tÄ›nÃ­)
 â””â”€â”€ nibe.log          (pokud je povolen, vytvoÅ™Ã­ ho skript)
</code></pre>

<p>Pokud chcete pouÅ¾Ã­t jinÃ© umÃ­stÄ›nÃ­, je nutnÃ© upravit cestu k logu a pÅ™Ã­padnÄ› v plÃ¡novaÄi Ãºloh upravit pÅ™Ã­kaz pro spuÅ¡tÄ›nÃ­ skriptu.</p>

<p><strong>PÅ™Ã­klad pÅ™Ã­kazu v PlÃ¡novaÄi Ãºloh:</strong></p>
<pre><code>sleep 60 && nohup /bin/python3 /volume1/nibe/nibe.py > /volume1/nibe/nibe.log 2>&1 &
</code></pre>

<p>Tento skript spustÃ­ aplikaci na pozadÃ­ a uklÃ¡dÃ¡ log do:</p>
<pre><code>/volume1/nibe/nibe.log
</code></pre>

<p><strong>PoznÃ¡mka:</strong> Soubor <code>token.json</code> nenÃ­ nutnÃ© vytvÃ¡Å™et ruÄnÄ›, vytvoÅ™Ã­ se automaticky pÅ™i prvnÃ­m ÃºspÄ›Å¡nÃ©m zÃ­skÃ¡nÃ­ tokenu.</p>

<hr />


<h2>âš™ Konfigurace <code>config.ini</code> (DÅ®LEÅ½ITÃ‰)</h2>

<p>ğŸ“Œ <strong>V <code>config.ini</code> NEPOUÅ½ÃVAT uvozovky</strong> u <code>CLIENT_ID</code>, <code>CLIENT_SECRET</code>, <code>REFRESH_TOKEN</code>, <code>DEVICE_ID</code>.<br>
Pokud tam uvozovky jsou, myUplink vrÃ¡tÃ­ chybu <strong>invalid_client</strong>.</p>

<p>SprÃ¡vnÃ¡ podoba:</p>
<pre><code>[myuplink]
CLIENT_ID = 2499b39f-xxxx-xxxx-xxxx-xxxxxxxxxxxx
CLIENT_SECRET = 1234567890ABCDEF1234567890ABCDEF
REFRESH_TOKEN = ABCDEFGHIJKLMNOPQRSTUVWXYZ123456
DEVICE_ID = emmy-r-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

[loxone]
IP = 192.168.4.10
USER = admin
PASS = heslo

[runtime]
UPDATE_INTERVAL = 60
LOG_ENABLED = true
LOG_FILE = /volume1/homes/nibe/nibe.log
</code></pre>

<hr />

<h2>ğŸ” ZÃ­skÃ¡nÃ­ OAuth kÃ³du a refresh tokenu</h2>

<p>NejdÅ™Ã­ve je potÅ™eba vygenerovat autorizaÄnÃ­ kÃ³d a nÃ¡slednÄ› z nÄ›j zÃ­skat <code>refresh_token</code>, kterÃ½ skript pouÅ¾Ã­vÃ¡ pro dalÅ¡Ã­ komunikaci s API.</p>

<h3>1ï¸âƒ£ NastavenÃ­ aplikace v myUplink Developer portÃ¡lu</h3>

<p>OtevÅ™ete: <a href="https://dev.myuplink.com" target="_blank">https://dev.myuplink.com</a></p>

<ul>
  <li><strong>Application Name:</strong> libovolnÃ½ napÅ™. <code>loxone</code></li>
  <li><strong>Description:</strong> libovolnÃ©</li>
  <li><strong>Callback URL:</strong> <code>http://localhost/</code></li>
</ul>

<p><strong>PoznÃ¡mka:</strong> <code>Callback URL</code> musÃ­ <strong>naprosto pÅ™esnÄ›</strong> odpovÃ­dat hodnotÄ› pouÅ¾itÃ­ v parametru <code>redirect_uri</code>.</p>

<h3>2ï¸âƒ£ OtevÅ™enÃ­ autorizaÄnÃ­ URL </h3>

<p>PÅ™epiÅ¡te CLIENT_ID a do prohlÃ­Å¾eÄe vloÅ¾te nÃ¡sledujÃ­cÃ­ URL (vÄetnÄ› URL encode znakÅ¯). Dejte pozor na sprÃ¡vnÃ½ tvar redirect_uri - Callback URL:</p>

<pre><code>https://api.myuplink.com/oauth/authorize?response_type=code&client_id=CLIENT_ID&redirect_uri=http%3A%2F%2Flocalhost%2F&scope=READSYSTEM%20offline_access&state=xyz
</code></pre>

<p>Po pÅ™ihlÃ¡Å¡enÃ­ a odsouhlasenÃ­ prÃ¡v budete pÅ™esmÄ›rovÃ¡ni na:</p>

<pre><code>http://localhost/?code=XXXXXXXXXXXX&scope=READSYSTEM%20offline_access&state=xyz
</code></pre>

<p>Hodnotu <code>code=...</code> si zkopÃ­rujte.</p>

<h3>3ï¸âƒ£ ZÃ­skÃ¡nÃ­ refresh tokenu pÅ™es curl. PÅ™epiÅ¡te ZISKANY_CODE, CLIENT_ID a CLIENT_SECRET. Pozor na sprÃ¡vnÃ© redurect_uri</h3>

<pre><code>curl -X POST "https://api.myuplink.com/oauth/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=authorization_code&code=ZISKANY_CODE&client_id=CLIENT_ID&client_secret=CLIENT_SECRET&redirect_uri=http%3A%2F%2Flocalhost%2F"
</code></pre>

<p>SprÃ¡vnÃ¡ odpovÄ›Ä obsahuje napÅ™Ã­klad:</p>

<pre><code>{
  "access_token": ".....",
  "expires_in": 3600,
  "token_type": "Bearer",
  "refresh_token": "ZDE_REFRESH_TOKEN",
  "scope": "READSYSTEM offline_access"
}
</code></pre>

<h3>4ï¸âƒ£ UloÅ¾enÃ­ refresh tokenu do <code>config.ini</code></h3>

<pre><code>[myuplink]
CLIENT_ID = "...."
CLIENT_SECRET = "...."
REFRESH_TOKEN = "ZDE_REFRESH_TOKEN"
</code></pre>

<p>TÃ­m je proces autentizace hotovÃ½ a skript bude potÃ© tokeny automaticky obnovovat.</p>

<hr />

<h2>â–¶ PrvnÃ­ test</h2>
<p>JednorÃ¡zovÃ½ test bez zÃ¡pisu do Loxone:</p>
<pre><code>/bin/python3 /volume1/nibe/nibe.py --once --dry-run
</code></pre>

<p>OÄekÃ¡vanÃ½ vÃ½stup:</p>
<pre><code>Access token refreshed
[dry-run] Would send Nibe_OutdoorTemp = -2.5
[dry-run] Would send Nibe_OutdoorTempAvg = -2.2
...
</code></pre>

<hr />

<h2>ğŸ›° OdesÃ­lÃ¡nÃ­ dat do Loxone</h2>

<p>NÃ¡zvy Virtual Inputs musÃ­ odpovÃ­dat hodnotÃ¡m v <code>points_map.json</code>, napÅ™.:</p>
<pre><code>Nibe_OutdoorTemp
Nibe_Flow
Nibe_CompressorHours
</code></pre>

<p><strong>Seznam parametrÅ¯ z Nibe:</strong></p>
<pre><code>/bin/python3 nibe.py --print-params
</code></pre>

<p><strong>GenerovÃ¡nÃ­ XML Å¡ablony VI pro import do Loxone. MÅ¯Å¾ete si virtuÃ¡lnÃ­ promÄ›nnÃ© pojmenovat podle sebe v souboru points_map:</strong></p>
<pre><code>/bin/python3 nibe.py --generate-xml
</code></pre>

<hr />

<h2>ğŸ” AutomatickÃ½ start na Synology</h2>

<p>V DSM:</p>
<ul>
  <li><strong>OvlÃ¡dacÃ­ panel â†’ PlÃ¡novaÄ Ãºloh â†’ PÅ™idat â†’ Skript uÅ¾ivatele root</strong></li>
</ul>

<p>Skript napÅ™.:</p>
<pre><code>sleep 60 && nohup /bin/python3 /volume1/nibe/nibe.py > /volume1/nibe/nibe.log 2>&1 &
</code></pre>

<hr />

<h2>ğŸ©º Troubleshooting</h2>

<table>
  <tr>
    <th>Chyba</th>
    <th>Å˜eÅ¡enÃ­</th>
  </tr>
  <tr>
    <td><code>invalid_client</code></td>
    <td>Odstranit uvozovky v <code>config.ini</code>, zkontrolovat CLIENT_ID / SECRET podle dev.myuplink.com</td>
  </tr>
  <tr>
    <td><code>invalid_grant</code></td>
    <td>Refresh token expiroval â€” znovu zÃ­skat <code>code</code> a <code>refresh_token</code> podle postupu vÃ½Å¡e</td>
  </tr>
  <tr>
    <td><code>module 'requests' has no attribute 'post'</code></td>
    <td>Nainstalovat <code>requests</code> pÅ™es pip pro sprÃ¡vnÃ½ Python (viz instalace vÃ½Å¡e)</td>
  </tr>
  <tr>
    <td>Hodnoty se neobjevujÃ­ v Loxone</td>
    <td>Zkontrolovat, zda nÃ¡zvy Virtual Inputs odpovÃ­dajÃ­ <code>points_map.json</code> a Å¾e skript nebÄ›Å¾Ã­ jen v <code>--dry-run</code> reÅ¾imu</td>
  </tr>
</table>

<hr />

<p><strong>ğŸ‘ Hotovo.</strong><br>
Pokud mÃ¡te pÅ™ipravenÃ© VI v Loxone a sprÃ¡vnÄ› nastavenÃ½ <code>config.ini</code>, hodnoty se zaÄnou pravidelnÄ› aktualizovat podle <code>UPDATE_INTERVAL</code>.</p>

</body>
</html>
